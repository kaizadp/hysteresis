---
title: "Hysteresis and Soil C"
author: "Kaizad Patel"
output: html_document
---
Run: `r Sys.Date()`

Results for HYPROP, Picarro, WEOC

```{r setup, include=FALSE}

knitr::opts_chunk$set(dpi = 300,
                      echo=FALSE,message=FALSE,warning=FALSE,
                      collapse = TRUE,
                      comment = "#>", 
                      fig.path = "images/markdown/")

source("0-hysteresis_packages.R")
```

# HYPROP
```{r hyprop, fig.width=9, dpi=300}
source("2-hyprop.R")

ggplot(hyprop, aes(y = kPa, x = perc_sat, color = treatment, linetype=treatment))+
  geom_path(size=1.5)+
  scale_color_manual(labels = c("drying","rewetting"), values = c("darkorange2","gray40"), na.translate=F)+
  scale_linetype_manual(labels = c("drying","rewetting"), values = c("solid","twodash"), na.translate=F)+
  facet_wrap(.~soiltype)+
  ylab ("tension, kPa")+
  scale_x_reverse(name = "percent saturation")+
  theme_kp()


ggplot(hyprop, aes(y = kPa, x = perc_sat, color = treatment, linetype=treatment))+
  geom_path(size=1.5)+
  scale_color_manual(labels = c("drying","rewetting"), values = c("darkorange2","gray40"), na.translate=F)+
  scale_linetype_manual(labels = c("drying","rewetting"), values = c("solid","twodash"), na.translate=F)+
  facet_wrap(.~soiltype)+
  ylab ("tension, kPa (log scale)")+
  xlab ("percent saturation")+
#  scale_x_reverse(name = "percent saturation")+
  scale_y_log10()+
 # xlim(0,100)+
  theme_kp()


ggplot(hyprop, aes(y = kPa, x = perc_sat, color = treatment, linetype=treatment))+
  geom_path(size=1.5)+
  scale_color_manual(labels = c("drying","rewetting"), values = c("darkorange2","gray40"), na.translate=F)+
  scale_linetype_manual(labels = c("drying","rewetting"), values = c("solid","twodash"), na.translate=F)+
  facet_wrap(.~soiltype)+
  ylab ("tension, kPa (log scale)")+
  xlab ("percent saturation")+
#  scale_x_reverse(name = "percent saturation")+
  scale_y_log10()+
  scale_y_continuous(trans = log10_trans(),
                     sec.axis = sec_axis(~ .^-1 * 300, name = "pore size (um)"))+
 # xlim(0,100)+
  theme_kp()

```


# PICARRO

```{r picarro_files}
fluxes = read.csv("data/processed/picarro_fluxes.csv", stringsAsFactors = F) %>% 
  dplyr::mutate(sat_level = if_else(treatment=="FM", as.integer(53), sat_level))
meanfluxes_summary = read.csv("data/processed/picarro_meanfluxes_summary.csv", stringsAsFactors = F)
```

```{r picarro_anova}
aov2 = aov(flux_co2_nmol_gC_s ~ treatment*texture*sat_level, data = fluxes)
summary(aov2)
```

```{r respiration, fig.width=9}

label = tibble(x = c(50, 75, 100, 100),
               y = c(0.80, 1.10, 1.10, 0.90),
               texture = c("SCL", "SCL", "SCL", "SL"),
               label = c("*","*","*","*"),
               treatment = c("Drying", "Drying", "Drying", "Drying"))

ggplot(fluxes, aes(x = sat_level, y = flux_co2_nmol_gC_s, color = treatment, shape=treatment))+
  geom_point(position = position_dodge(width = 0.5), size=4, stroke=1.5)+
  geom_smooth(data = meanfluxes %>% filter(!treatment=="FM"), 
              aes(x = as.numeric(sat_level), y = flux_co2_nmol_gC_s), 
              linetype = "longdash", size = 1, se=FALSE)+
  geom_text(data = label, aes(x = x, y = y, label = label), size=12, color = "black")+
   # geom_vline(xintercept = 6.5)+
  ylab("mean flux_co2_nmol_gC_s")+
  scale_color_manual(breaks = c("Drying","Wetting", "FM"),
                     labels = c("drying","rewetting", "field moist"), values = c("darkorange2","gray40", "black"), na.translate=F)+
  scale_shape_manual(breaks = c("Drying","Wetting", "FM"),
                     labels = c("drying","rewetting", "field moist"), values = c(16,1, 4), na.translate=F)+
  facet_grid(.~texture)+
  #scale_x_reverse(name = "percent saturation")+
  ylab(expression(bold(paste("mean CO"[2]," flux, nmol g"^{-1}, "C s"^{-1}))))+
  xlab("percent saturation")+
  #ggtitle("mean CO2 flux per g C")+
  theme_kp()
```

# WSOC
```{r wsoc_files}
wsoc = read.csv(WSOC, stringsAsFactors = F) %>% 
  dplyr::mutate(sat_level = if_else(treatment=="FM", as.integer(53), sat_level))
wsoc_summary = read.csv("data/processed/wsoc_summary.csv", stringsAsFactors = F)
wsoc_label =
  wsoc_summary %>%
  group_by(texture, sat_level) %>% 
  dplyr::mutate(y = max(wsoc)+0.05) %>% 
  na.omit()
```

```{r wsoc_graphs, fig.width=9}

ggplot(wsoc, aes(x = sat_level, y = wsoc_mg_g, color = treatment, shape = treatment))+
  geom_point(size=3, stroke=1.5)+
  geom_text(data = wsoc_label %>% na.omit(), aes(x = sat_level, y = y, label = asterisk), color = "black", size=12)+
  scale_color_manual(labels = c("drying","field moist","rewetting"), 
                     values = c("darkorange2","black","gray40"), na.translate=F)+
  scale_shape_manual(labels = c("drying","field moist","rewetting"), values = c(16,4,1), na.translate=F)+
  facet_grid(.~texture)+
  ylab(expression(bold(paste("WSOC, mg g"^{-1}))))+
  xlab("percent saturation")+
#  scale_x_reverse(name = "percent saturation")+
  theme_kp()

```


```{r, include=F}
# merge wsoc_results and cum_flux

merged = 
  wsoc_results %>% 
  mutate(Core = as.numeric(Core)) %>% 
  left_join(cum_flux, by = "Core")

names(merged)
 
ggplot(merged[!merged$moisture_lvl.x==5,], aes(x = wsoc_mg_g, y = mean, color = perc_sat_actual))+
  geom_point()+
  facet_grid(treatment.y~soil_type.x)

```

