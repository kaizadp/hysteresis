---
title: "Hysteresis and Soil C"
author: "Kaizad Patel"
date: "11/14/2019"
output: word_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo=FALSE,message=FALSE,warning=FALSE,
                      collapse = TRUE,
                      comment = "#>" #, fig.path = "images/"
                      )

source("3c-picarro_output_NODRAKE.R")

cum_flux = readd(cum_flux)
gf = readd(gf)
meanflux = readd(meanflux)
mean_percsat = readd(mean_percsat)




```
Run: `r Sys.Date()`


# 1. PICARRO DATA

## initial plots, QA, QC
number of readings


```{r num}
ggplot(cum_flux, aes(x = Core, y = n))+
    geom_point()+
    ggtitle("no. of readings")
```

each core
```{r, fig.width=15, fig.height=15}
ggplot(gf, aes(DATETIME, flux_co2_umol_g_s*1000, color = Sand)) + 
    geom_point() + geom_line() +
    ylab("flux_co2_nmol_g_s")+
    facet_wrap(~Core, scale = "free_x")+
    geom_hline(yintercept = 0)+
    theme(legend.position="none")
```

```{r, fig.width=8, fig.height=8}
ggplot(gf, aes(DATETIME, flux_co2_umol_g_s*1000, color = Core_assignment)) + 
    geom_point() + geom_line() +
    ylab("flux_co2_nmol_g_s")+
    facet_wrap(~Core_assignment, scale = "free_x")+
    geom_hline(yintercept = 0)+
    theme(legend.position="none")
  
```

## normalized to soil
```{r soil}
ggplot(cum_flux, aes(x = moisture_lvl, y = cum*1000, color = trt))+
    geom_point(position = position_dodge(width = 0.5))+
    geom_smooth(data = meanflux, aes(x = as.numeric(moisture_lvl), y = cum*1000))+
    geom_vline(xintercept = 6.5)+
    ylab("cum flux_co2_nmol_g_s")+
    facet_grid(soil_type~.)+
    ggtitle("cumulative CO2 flux")
  
ggplot(cum_flux, aes(x = moisture_lvl, y = max*1000, color = trt))+
    geom_point(position = position_dodge(width = 0.5))+
    geom_smooth(data = meanflux, aes(x = as.numeric(moisture_lvl), y = max*1000))+
    geom_vline(xintercept = 6.5)+
    ylab("maximum flux_co2_nmol_g_s")+
    facet_grid(soil_type~.)+
    ggtitle("maximum CO2 flux")
```

## normalized to TC content
```{r carbon}
ggplot(cum_flux, aes(x = moisture_lvl, y = cumC*1000, color = trt))+
    geom_point(position = position_dodge(width = 0.5))+
    geom_smooth(data = meanflux, aes(x = as.numeric(moisture_lvl), y = cumC*1000))+
    geom_vline(xintercept = 6.5)+
    ylab("cum flux_co2_nmol_gC_s")+
    facet_grid(soil_type~.)+
    ggtitle("cumulative CO2 flux per g C")
  
ggplot(cum_flux, aes(x = moisture_lvl, y = maxC*1000, color = trt))+
    geom_point(position = position_dodge(width = 0.5))+
    geom_smooth(data = meanflux, aes(x = as.numeric(moisture_lvl), y = maxC*1000))+
    geom_vline(xintercept = 6.5)+
    ylab("maximum flux_co2_nmol_gC_s")+
    facet_grid(soil_type~.)+
    ggtitle("maximum CO2 flux - C")
```

## using percent saturation
```{r perc_sat}

ggplot(cum_flux, aes(x = perc_sat, y = cumC*1000, color = trt))+
    geom_point(position = position_dodge(width = 0.5))+
    geom_smooth(data = mean_percsat, aes(x = as.numeric(perc_sat), y = cumC*1000))+
   # geom_vline(xintercept = 6.5)+
    ylab("cum flux_co2_nmol_gC_s")+
    facet_grid(soil_type~.)+
    scale_x_reverse(name = "percent saturation")+
    ggtitle("cumulative CO2 flux per g C")
  
ggplot(cum_flux, aes(x = perc_sat, y = maxC*1000, color = trt))+
    geom_point(position = position_dodge(width = 0.5))+
    geom_smooth(data = mean_percsat, aes(x = as.numeric(perc_sat), y = maxC*1000))+
    # geom_vline(xintercept = 6.5)+
    ylab("max flux_co2_nmol_gC_s")+
    facet_grid(soil_type~.)+
    scale_x_reverse(name = "percent saturation")+
    ggtitle("max CO2 flux per g C")
```


## questions
1. Do we delete flux values below zero?

2. Fluxes keep oscillating (Fig. 1). Do we know what's causing that? It's not day-night cycles, since each core was analyzed for only ~24 hours.

3. Soil_50_W (cores 111-115 in Fig. 2) had an initial spike. The samples were initially air-dry and then wetted, so it could be the Birch effect. But this was very short-lived, and this wasn't seen in any of the other "_W" soils. So maybe trailing CO2 from previous samples?

    Do we delete the initial pulse?

4. Soil_sand_dry_W, FIg. 1 (core 95, Fig. 2) had an initial spike and then almost no respiration. Pretty sure that's "wrong" data, since the samples were air-dry and no moisture added. Delete that high value?

5. There were unequal number of readings across cores (Fig. 4), as some ran a little longer than others, like 24 vs. 25 hours. That would influence the cumulative flux calculation. Do we (a) somehow filter data to keep it consistent; (b) leave as is; or (c) represent data a different way (e.g. max/mean flux)?